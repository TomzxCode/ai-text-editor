# Implementation Plan for Issue #4

## Issue Summary
Allow users to request a diff as response and display what it would look like if it was applied to the current text. The issue suggests using CodeMirror's merge view feature to show side-by-side or unified diff views of AI-generated changes.

## Feasibility Assessment
- **Status**: ‚úÖ Feasible
- **Complexity**: Medium-High
- **Estimated Effort**: 10-15 hours

## Technical Analysis

### Current State
The application already uses:
- **CodeMirror 5.65.16** for the main editor (from CDN)
- **Prompt action types**: 'feedback', 'insert', 'replace' (defined in `PromptsManager.js:59`)
- **AIService** handles different action types with specialized prompts
- **UIManager** manages tabs and navigation
- **EditorManager** wraps CodeMirror functionality

### Dependencies Required
- **CodeMirror Merge Addon** (diff addon): `https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/merge/merge.min.js`
- **CodeMirror Merge CSS**: `https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/merge/merge.min.css`
- **jsDiff library**: Usually bundled with CodeMirror merge addon

## Proposed Solution

### Overview
Add a new 'diff' action type to the prompt system that creates a side-by-side merge view showing the original text alongside AI-suggested changes. Users can review individual changes, accept/reject them, and apply approved changes to the main editor.

### Architecture

#### 1. New DiffViewManager Component
Create `components/DiffViewManager.js` to manage CodeMirror merge view instances:

```javascript
class DiffViewManager {
    constructor(container, options = {}) {
        this.container = container;
        this.mergeView = null;
        this.originalText = '';
        this.modifiedText = '';
        this.onAccept = options.onAccept || null;
        this.onReject = options.onReject || null;
    }

    showDiff(original, modified, options = {}) {
        // Creates CodeMirror merge view
        // original: current editor content
        // modified: AI-suggested changes
        // options: { mode, theme, readOnly }
    }

    acceptChanges() {
        // Apply approved changes to main editor
    }

    rejectChanges() {
        // Close diff view without changes
    }

    acceptIndividualChange(changeIndex) {
        // Accept a specific change
    }

    rejectIndividualChange(changeIndex) {
        // Reject a specific change
    }

    close() {
        // Clean up merge view
    }
}
```

#### 2. Update PromptsManager
Add 'diff' to valid action types:

**File**: `components/PromptsManager.js:58-61`
```javascript
validateActionType(actionType) {
    const validActionTypes = ['feedback', 'insert', 'replace', 'diff'];
    return validActionTypes.includes(actionType) ? actionType : 'feedback';
}
```

#### 3. Update AIService
Handle diff responses in `getPromptFeedback` method:

**File**: `components/AIService.js:86-276`

Add diff-specific prompt formatting:
```javascript
// In getPromptFeedback, around line 123
if (promptConfig.actionType === 'diff') {
    fullPrompt = `${processedPrompt}

Provide your response as a complete replacement of the original text. Your response should be the full modified text, not just the changes.

Return ONLY the modified text content without explanations, HTML formatting, or additional commentary.`;
}
```

Add diff response handler:
```javascript
handleDiffResponse(cleanedResponse, textAnalysisManager, promptConfig) {
    // Create diff view using DiffViewManager
    // Store diff for later viewing in diff tab
    return {
        htmlContent: '<div class="diff-available">Diff ready to review</div>',
        responseType: 'diff',
        originalText: textAnalysisManager.getFullText(),
        modifiedText: cleanedResponse,
        actionType: 'diff'
    };
}
```

#### 4. Update UIManager
Add diff tab management:

**File**: `components/UIManager.js`

Add to tab navigation:
```javascript
// Add new tab button for diffs (around line 158)
<button class="tab-btn" id="diffTab" data-tab="diff">Diff</button>
```

Add diff tab content:
```javascript
<!-- Diff Tab Content -->
<div class="tab-content" id="diffTabContent">
    <div class="diff-section">
        <div class="diff-header">
            <h4>Pending Changes</h4>
            <div class="diff-actions">
                <button class="btn-primary" id="acceptAllDiffs">Accept All</button>
                <button class="btn-secondary" id="rejectAllDiffs">Reject All</button>
            </div>
        </div>
        <div class="diff-container" id="diffContainer">
            <p class="no-diffs">No pending changes to review.</p>
        </div>
        <div class="diff-list" id="diffList">
            <!-- List of available diffs -->
        </div>
    </div>
</div>
```

#### 5. Update Main Application
Connect all components in `script.js`:

```javascript
// In AITextEditor constructor
this.diffViewManager = new DiffViewManager(
    document.getElementById('diffContainer'),
    {
        onAccept: (original, modified) => {
            this.editorManager.replaceTextAtPosition(modified);
        },
        onReject: () => {
            this.diffViewManager.close();
        }
    }
);
```

### Implementation Steps

#### Step 1: Add Merge View Dependencies
**Files to modify**: `index.html`

**Approach**:
- Add CodeMirror merge addon CSS after line 72 (after choices.js CSS)
- Add CodeMirror merge addon JS after line 713 (after main CodeMirror JS)
- Add jsDiff library if not bundled

**Code changes**:
```html
<!-- After line 72 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/merge/merge.min.css">

<!-- After line 712 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/merge/merge.min.js"></script>
```

**Testing**: Verify CDN links load correctly in browser console

#### Step 2: Create DiffViewManager Component
**Files to create**: `components/DiffViewManager.js`

**Approach**:
- Create ES6 class following existing component pattern
- Initialize CodeMirror merge view with proper configuration
- Handle accept/reject/change operations
- Support both side-by-side and unified diff views
- Theme-aware (respect dark/light mode)

**Key methods**:
- `showDiff(original, modified)` - Create merge view
- `acceptChanges()` - Apply all changes to main editor
- `rejectChanges()` - Close without applying
- `close()` - Clean up and remove merge view
- `getChanges()` - Return list of individual changes

**Testing**:
- Create merge view with sample text
- Verify diff highlights correctly
- Test accept/reject buttons
- Test theme switching

#### Step 3: Update Prompt System
**Files to modify**: `components/PromptsManager.js`

**Approach**:
- Add 'diff' to validActionTypes array
- Update prompt action type dropdown in HTML
- Migrate existing prompts if needed (should default to 'feedback')

**Code changes**:
```javascript
// Line 58-61
validateActionType(actionType) {
    const validActionTypes = ['feedback', 'insert', 'replace', 'diff'];
    return validActionTypes.includes(actionType) ? actionType : 'feedback';
}
```

**HTML changes** (around line 584 in index.html):
```html
<select id="promptActionType">
    <option value="feedback">Show as feedback</option>
    <option value="diff">Show as diff view</option>
    <option value="insert">Insert into editor</option>
    <option value="replace">Replace text</option>
</select>
```

**Testing**:
- Create prompt with diff action type
- Verify validation works
- Check migration doesn't break existing prompts

#### Step 4: Update AIService
**Files to modify**: `components/AIService.js`

**Approach**:
- Modify `getPromptFeedback` to handle diff action type
- Add specialized prompt instructions for diff
- Create diff response handler
- Store diff data for later viewing

**Code changes**:
1. Update prompt formatting (around line 123):
```javascript
if (isInteractivePrompt) {
    if (promptConfig.actionType === 'replace') {
        // existing replace logic
    } else if (promptConfig.actionType === 'diff') {
        fullPrompt = `${processedPrompt}

Provide a complete rewrite of the text with your improvements applied. Return ONLY the modified text content without explanations, formatting, or commentary.`;
    } else {
        // existing insert logic
    }
}
```

2. Add diff response handler (after line 541):
```javascript
handleDiffResponse(generatedText, textAnalysisManager, promptConfig) {
    const originalText = textAnalysisManager ? textAnalysisManager.getFullText() : '';

    // Store diff for later viewing
    const diffId = `diff_${Date.now()}`;
    const diffData = {
        id: diffId,
        promptName: promptConfig.name || 'Diff',
        originalText: originalText,
        modifiedText: generatedText,
        timestamp: new Date().toISOString(),
        applied: false
    };

    // Store in diff manager or notify UIManager
    if (window.app?.uiManager) {
        window.app.uiManager.addDiffToQueue(diffData);
    }

    return {
        htmlContent: this.createDiffNotificationHTML(diffData),
        responseType: 'diff',
        diffData: diffData
    };
}

createDiffNotificationHTML(diffData) {
    return `
        <div class="feedback-item diff-prompt">
            <h4>üìù ${this.escapeHTML(diffData.promptName)} - Diff Ready</h4>
            <div class="category-section">
                <div class="analysis-content">
                    <p>‚úÖ Diff generated successfully. <button class="btn-link" onclick="window.app?.uiManager?.showDiff('${diffData.id}')">View Changes</button></p>
                    <p><small>Original: ${diffData.originalText.length} chars ‚Üí Modified: ${diffData.modifiedText.length} chars</small></p>
                </div>
            </div>
        </div>
    `;
}
```

3. Update response handling (around line 239):
```javascript
if (isInteractivePrompt) {
    if (promptConfig.actionType === 'replace') {
        this.handleInteractivePromptResponse(cleanedResponse, textAnalysisManager, promptConfig.actionType);
        // existing replace response
    } else if (promptConfig.actionType === 'diff') {
        return this.handleDiffResponse(cleanedResponse, textAnalysisManager, promptConfig);
    } else {
        // existing insert response
    }
}
```

**Testing**:
- Create diff prompt and trigger it
- Verify AI response is captured correctly
- Check diff notification appears
- Test viewing diff in diff tab

#### Step 5: Update UIManager
**Files to modify**: `components/UIManager.js`

**Approach**:
- Add diff tab to navigation
- Create diff tab content structure
- Add diff queue management
- Handle diff view display
- Wire up accept/reject buttons

**Key additions**:
1. Tab structure (in HTML section)
2. Diff queue storage
3. Diff display methods
4. Event handlers for diff actions

**Testing**:
- Navigate to diff tab
- View pending diffs
- Test accept/reject buttons
- Verify changes apply to editor

#### Step 6: Update Main Application
**Files to modify**: `script.js`

**Approach**:
- Initialize DiffViewManager
- Connect diff events to editor operations
- Handle diff tab switching
- Manage diff lifecycle

**Code changes**:
```javascript
// In constructor
this.diffViewManager = new DiffViewManager(
    document.getElementById('diffContainer'),
    {
        onAccept: (original, modified) => {
            if (this.editorManager) {
                this.editorManager.setValue(modified);
            }
        },
        onReject: () => {
            // Just close diff view
        }
    }
);

// Pass to UIManager
this.uiManager.setDiffViewManager(this.diffViewManager);
```

**Testing**:
- Initialize app with diff manager
- Create diff from prompt
- View diff in tab
- Accept changes and verify editor updates

#### Step 7: Add Diff View Styling
**Files to modify**: `styles.css`

**Approach**:
- Add styles for merge view container
- Style diff tab content
- Add diff action buttons
- Ensure mobile responsiveness
- Theme-aware styling

**CSS additions**:
```css
/* Diff Tab Styles */
.diff-section {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

.diff-header {
    padding: 1rem;
    background-color: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.diff-actions {
    display: flex;
    gap: 0.5rem;
}

.diff-container {
    flex: 1;
    overflow: hidden;
    position: relative;
}

.CodeMirror-merge {
    height: 100%;
}

.diff-list {
    max-height: 200px;
    overflow-y: auto;
    border-top: 1px solid var(--border-color);
}

.diff-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.diff-item:hover {
    background-color: var(--bg-quaternary);
}

.diff-item.active {
    background-color: var(--bg-tertiary);
    border-left: 3px solid var(--accent-color);
}

.no-diffs {
    padding: 2rem;
    text-align: center;
    color: var(--text-tertiary);
}

.btn-link {
    background: none;
    border: none;
    color: var(--accent-color);
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
}

.btn-link:hover {
    color: var(--accent-hover);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .diff-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: stretch;
    }

    .diff-actions {
        flex-direction: column;
    }
}
```

**Testing**:
- Verify diff view displays correctly
- Test on mobile devices
- Check theme switching
- Verify button states

### Dependencies
- **External**: CodeMirror merge addon (CDN)
- **Internal**: EditorManager, UIManager, AIService, PromptsManager

### Risk Assessment

#### Potential Risks

1. **Merge view complexity**
   - Risk: CodeMirror merge view API can be complex
   - Mitigation: Start with basic side-by-side view, add features incrementally
   - Fallback: Use simpler diff display if merge view proves problematic

2. **Large file performance**
   - Risk: Diff generation may be slow for large texts
   - Mitigation: Add loading indicators, consider debouncing
   - Limit: Warn users for texts > 10,000 chars

3. **Theme compatibility**
   - Risk: Merge view may not respect all themes
   - Mitigation: Test with popular themes, add custom CSS overrides
   - Fallback: Use neutral styling for merge view

4. **State management**
   - Risk: Multiple diffs could cause confusion
   - Mitigation: Only allow one active diff at a time, queue others
   - UX: Show clear pending diffs count

5. **Mobile experience**
   - Risk: Side-by-side diff doesn't work well on mobile
   - Mitigation: Use unified view on mobile, add swipe gestures
   - Responsive: Stack panels vertically on small screens

## Alternatives Considered

### Alternative 1: Inline Diff Highlights
Show diff highlights directly in the main editor with accept/reject buttons per change.
- **Pros**: Simpler implementation, no new tab needed
- **Cons**: Harder to see full context, clutters editor, no side-by-side comparison
- **Rejected**: Issue specifically mentions CodeMirror merge view

### Alternative 2: Separate Modal Window
Open diff in a modal overlay instead of a tab.
- **Pros**: Focus mode, doesn't disrupt UI
- **Cons**: Loses editor context, harder to reference original
- **Rejected**: Tab approach allows simultaneous viewing

### Alternative 3: External Diff Service
Use an external diff library/service instead of CodeMirror merge.
- **Pros**: More features, potentially better performance
- **Cons**: New dependency, integration complexity
- **Rejected**: CodeMirror merge is already aligned with tech stack

## Implementation Order

1. **Phase 1** (4-5 hours): Core infrastructure
   - Add CDN dependencies
   - Create DiffViewManager
   - Update PromptsManager
   - Basic merge view rendering

2. **Phase 2** (4-5 hours): Integration
   - Update AIService for diff handling
   - Update UIManager with diff tab
   - Connect main app components
   - Basic diff flow working

3. **Phase 3** (2-3 hours): Polish
   - Add styling and theming
   - Mobile responsiveness
   - Error handling
   - Edge cases

4. **Phase 4** (1-2 hours): Testing
   - Test with various prompt types
   - Test with different file sizes
   - Test theme switching
   - Test mobile experience

## Testing Checklist

- [ ] Create diff-type prompt in Prompts tab
- [ ] Trigger diff prompt and receive AI response
- [ ] Diff notification appears in feedback
- [ ] Navigate to Diff tab
- [ ] View diff in merge view
- [ ] See side-by-side comparison
- [ ] Accept individual changes
- [ ] Reject individual changes
- [ ] Accept all changes
- [ ] Reject all changes
- [ ] Changes apply to main editor correctly
- [ ] Diff closes after action
- [ ] Multiple diffs queue correctly
- [ ] Mobile view works (unified diff)
- [ ] Theme switching works
- [ ] Large file handling (> 10k chars)
- [ ] Empty diff handling
- [ ] Error handling (API failures)
- [ ] Keyboard shortcuts work

## Edge Cases to Handle

1. **Empty AI response**: Show error, don't create diff
2. **Identical text**: Show "no changes" message
3. **Very large diffs**: Truncate or warn user
4. **Special characters**: Ensure proper escaping
5. **Concurrent diffs**: Queue or reject new diff while one is active
6. **Editor modification during diff**: Warn user or invalidate diff
7. **Network errors**: Show retry option in diff tab
8. **File switching**: Clear pending diffs or save per-file

## Files Summary

### New Files
- `components/DiffViewManager.js` (~300 lines)

### Modified Files
- `index.html` (+10 lines for CDN, +50 lines for diff tab UI)
- `components/PromptsManager.js` (+1 line, modify 1 line)
- `components/AIService.js` (+80 lines for diff handling)
- `components/UIManager.js` (+100 lines for diff tab management)
- `script.js` (+20 lines for DiffViewManager integration)
- `styles.css` (+80 lines for diff styling)

### Total Lines
- New: ~300
- Modified: ~340
- **Total: ~640 lines**

## References
- **CodeMirror Merge View**: https://codemirror.net/doc/manual.html#addon_merge
- **CodeMirror Merge Demo**: https://codemirror.net/demo/merge.html
- **jsDiff Documentation**: https://github.com/kpdecker/jsdiff
- **Related issues**: #4
- **Related PRs**: None yet
